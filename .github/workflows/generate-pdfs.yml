name: Generate PDFs from HTML

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    types: [closed]
    paths:
      - 'Tutorials/**/Files/**/*.html'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (leave empty to process all HTML files)'
        required: false
        type: string

jobs:
  generate-pdfs:
    name: Generate PDFs
    # Only run if PR was merged (not just closed) OR manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.pull_request.base.ref }}
        fetch-depth: 0
    
    - name: Get changed HTML files from PR
      id: changed-files
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ github.event.inputs.pr_number }}" ]]; then
            echo "Getting files changed in PR #${{ github.event.inputs.pr_number }}..."
            git fetch origin pull/${{ github.event.inputs.pr_number }}/head:pr-${{ github.event.inputs.pr_number }}
            html_files=$(git diff --name-only --diff-filter=AM origin/${{ github.event.repository.default_branch }} pr-${{ github.event.inputs.pr_number }} | grep '\.html$' | grep 'Tutorials/.*/Files/' || true)
          else
            echo "Finding all HTML files in repository..."
            html_files=$(find Tutorials -path '*/Files/*.html' -type f || true)
          fi
        else
          echo "Getting files changed in PR #${{ github.event.pull_request.number }}..."
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          html_files=$(git diff --name-only --diff-filter=AM ${{ github.event.pull_request.base.sha }} pr-${{ github.event.pull_request.number }} | grep '\.html$' | grep 'Tutorials/.*/Files/' || true)
        fi
        
        if [[ -z "$html_files" ]]; then
          echo "No HTML files found in PR changes"
          echo "has_html=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found HTML files:"
        echo "$html_files"
        
        # Save to file for processing
        echo "$html_files" > /tmp/html_files.txt
        echo "has_html=true" >> $GITHUB_OUTPUT
        echo "count=$(echo "$html_files" | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Setup Node.js
      if: steps.changed-files.outputs.has_html == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Puppeteer
      if: steps.changed-files.outputs.has_html == 'true'
      run: |
        npm install puppeteer
        
        # Verify installation
        node --version
        npm --version
    
    - name: Create PDF generation script
      if: steps.changed-files.outputs.has_html == 'true'
      run: |
        cat > generate_pdf.js << 'EOF'
        const puppeteer = require('puppeteer');
        const fs = require('fs');
        const path = require('path');

        async function generatePDF(htmlPath, pdfPath) {
          const browser = await puppeteer.launch({
            headless: 'new',
            args: ['--no-sandbox', '--disable-setuid-sandbox']
          });
          
          try {
            const page = await browser.newPage();
            
            // Resolve absolute path and convert to file:// URL
            const absolutePath = path.resolve(htmlPath);
            const fileUrl = `file://${absolutePath}`;
            
            console.log(`Loading HTML from: ${fileUrl}`);
            
            // Use goto instead of setContent to properly load local resources (images, etc.)
            await page.goto(fileUrl, {
              waitUntil: 'networkidle0',
              timeout: 60000
            });
            
            // Wait a bit for any remaining resources
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await page.pdf({
              path: pdfPath,
              format: 'A4',
              landscape: true,
              printBackground: true,
              preferCSSPageSize: false,
              margin: {
                top: '0.4in',
                right: '0.4in',
                bottom: '0.4in',
                left: '0.4in'
              }
            });
            
            console.log(`âœ… Generated: ${pdfPath}`);
            return true;
          } catch (error) {
            console.error(`âŒ Failed to generate ${pdfPath}:`, error.message);
            return false;
          } finally {
            await browser.close();
          }
        }

        const htmlFile = process.argv[2];
        const pdfFile = process.argv[3];

        generatePDF(htmlFile, pdfFile)
          .then(success => process.exit(success ? 0 : 1))
          .catch(err => {
            console.error('Error:', err);
            process.exit(1);
          });
        EOF
    
    - name: Generate PDFs
      if: steps.changed-files.outputs.has_html == 'true'
      run: |
        echo "Generating PDFs for ${{ steps.changed-files.outputs.count }} HTML files..."
        
        pdf_count=0
        
        while IFS= read -r html_file; do
          if [[ -f "$html_file" ]]; then
            # Generate PDF filename (replace .html with .pdf)
            pdf_file="${html_file%.html}.pdf"
            
            echo "Converting: $html_file -> $pdf_file"
            
            if node generate_pdf.js "$html_file" "$pdf_file"; then
              if [[ -f "$pdf_file" ]]; then
                echo "  ğŸ“„ Size: $(du -h "$pdf_file" | cut -f1)"
                pdf_count=$((pdf_count + 1))
              fi
            fi
          else
            echo "  âš ï¸ File not found: $html_file"
          fi
        done < /tmp/html_files.txt
        
        echo ""
        echo "Summary: Generated $pdf_count PDF files"
        echo "pdf_count=$pdf_count" >> $GITHUB_OUTPUT
      id: generate
    
    - name: Commit and push PDFs
      if: steps.changed-files.outputs.has_html == 'true' && steps.generate.outputs.pdf_count > 0
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create a new branch for the PDFs
        BRANCH_NAME="auto-pdf-generation-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH_NAME"
        
        # Add all generated PDF files
        git add 'Tutorials/**/Files/**/*.pdf'
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No new PDFs to commit"
          exit 0
        fi
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ github.event.inputs.pr_number }}" ]]; then
            git commit -m "Generate PDFs from HTML files" \
                       -m "- Generated from PR #${{ github.event.inputs.pr_number }}" \
                       -m "- ${{ steps.generate.outputs.pdf_count }} PDF files created" \
                       -m "- Auto-generated by generate-pdfs workflow"
          else
            git commit -m "Generate PDFs from HTML files" \
                       -m "- Generated for all HTML files" \
                       -m "- ${{ steps.generate.outputs.pdf_count }} PDF files created" \
                       -m "- Auto-generated by generate-pdfs workflow"
          fi
        else
          git commit -m "Generate PDFs from HTML files" \
                     -m "- Generated from PR #${{ github.event.pull_request.number }}" \
                     -m "- ${{ steps.generate.outputs.pdf_count }} PDF files created" \
                     -m "- Auto-generated by generate-pdfs workflow"
        fi
        
        git push origin "$BRANCH_NAME"
        
        echo "âœ… PDFs committed to branch $BRANCH_NAME"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      id: commit
    
    - name: Create Pull Request
      if: steps.changed-files.outputs.has_html == 'true' && steps.generate.outputs.pdf_count > 0
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ github.event.inputs.pr_number }}" ]]; then
            gh pr create \
              --title "Auto-generate PDFs from PR #${{ github.event.inputs.pr_number }}" \
              --body "This PR automatically generates PDF files from HTML files that were changed in PR #${{ github.event.inputs.pr_number }}.

        **Summary:**
        - ğŸ“„ Generated ${{ steps.generate.outputs.pdf_count }} PDF files
        - ğŸ¤– Auto-generated by the generate-pdfs workflow

        Please review and merge if the PDFs look correct." \
              --base main \
              --head "${{ steps.commit.outputs.branch_name }}"
          else
            gh pr create \
              --title "Auto-generate PDFs from all HTML files" \
              --body "This PR automatically generates PDF files from all HTML files in the repository.

        **Summary:**
        - ğŸ“„ Generated ${{ steps.generate.outputs.pdf_count }} PDF files
        - ğŸ¤– Auto-generated by the generate-pdfs workflow

        Please review and merge if the PDFs look correct." \
              --base main \
              --head "${{ steps.commit.outputs.branch_name }}"
          fi
        else
          gh pr create \
            --title "Auto-generate PDFs from PR #${{ github.event.pull_request.number }}" \
            --body "This PR automatically generates PDF files from HTML files that were changed in PR #${{ github.event.pull_request.number }}.

        **Summary:**
        - ğŸ“„ Generated ${{ steps.generate.outputs.pdf_count }} PDF files
        - ğŸ¤– Auto-generated by the generate-pdfs workflow

        Please review and merge if the PDFs look correct." \
            --base main \
            --head "${{ steps.commit.outputs.branch_name }}"
        fi
        
        echo "âœ… Pull request created successfully"
