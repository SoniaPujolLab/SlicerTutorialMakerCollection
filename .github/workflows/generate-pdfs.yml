name: Generate PDFs from HTML

permissions:
  contents: write

on:
  pull_request:
    types: [closed]
    paths:
      - 'Tutorials/**/Files/**/*.html'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (leave empty to process all HTML files)'
        required: false
        type: string

jobs:
  generate-pdfs:
    name: Generate PDFs
    # Only run if PR was merged (not just closed) OR manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.pull_request.base.ref }}
        fetch-depth: 0
    
    - name: Get changed HTML files from PR
      id: changed-files
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ github.event.inputs.pr_number }}" ]]; then
            echo "Getting files changed in PR #${{ github.event.inputs.pr_number }}..."
            git fetch origin pull/${{ github.event.inputs.pr_number }}/head:pr-${{ github.event.inputs.pr_number }}
            html_files=$(git diff --name-only --diff-filter=AM origin/${{ github.event.repository.default_branch }} pr-${{ github.event.inputs.pr_number }} | grep '\.html$' | grep 'Tutorials/.*/Files/' || true)
          else
            echo "Finding all HTML files in repository..."
            html_files=$(find Tutorials -path '*/Files/*.html' -type f || true)
          fi
        else
          echo "Getting files changed in PR #${{ github.event.pull_request.number }}..."
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          html_files=$(git diff --name-only --diff-filter=AM ${{ github.event.pull_request.base.sha }} pr-${{ github.event.pull_request.number }} | grep '\.html$' | grep 'Tutorials/.*/Files/' || true)
        fi
        
        if [[ -z "$html_files" ]]; then
          echo "No HTML files found in PR changes"
          echo "has_html=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found HTML files:"
        echo "$html_files"
        
        # Save to file for processing
        echo "$html_files" > /tmp/html_files.txt
        echo "has_html=true" >> $GITHUB_OUTPUT
        echo "count=$(echo "$html_files" | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Install PDF generation tools
      if: steps.changed-files.outputs.has_html == 'true'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y wkhtmltopdf
        
        # Verify installation
        wkhtmltopdf --version
    
    - name: Generate PDFs
      if: steps.changed-files.outputs.has_html == 'true'
      run: |
        echo "Generating PDFs for ${{ steps.changed-files.outputs.count }} HTML files..."
        
        pdf_count=0
        
        while IFS= read -r html_file; do
          if [[ -f "$html_file" ]]; then
            # Generate PDF filename (replace .html with .pdf)
            pdf_file="${html_file%.html}.pdf"
            
            echo "Converting: $html_file -> $pdf_file"
            
            # Generate PDF with wkhtmltopdf
            # Options:
            # --enable-local-file-access: allow loading local images
            # --print-media-type: use print CSS media type
            # --no-stop-slow-scripts: don't timeout on slow scripts
            # --orientation Landscape: landscape mode for better image display
            # --page-size A4: standard page size
            # --dpi 300: high resolution for images
            wkhtmltopdf \
              --enable-local-file-access \
              --print-media-type \
              --no-stop-slow-scripts \
              --orientation Landscape \
              --page-size A4 \
              --dpi 300 \
              --quiet \
              "$html_file" "$pdf_file"
            
            if [[ -f "$pdf_file" ]]; then
              echo "  ✅ Generated: $pdf_file ($(du -h "$pdf_file" | cut -f1))"
              pdf_count=$((pdf_count + 1))
            else
              echo "  ❌ Failed to generate: $pdf_file"
            fi
          else
            echo "  ⚠️ File not found: $html_file"
          fi
        done < /tmp/html_files.txt
        
        echo ""
        echo "Summary: Generated $pdf_count PDF files"
        echo "pdf_count=$pdf_count" >> $GITHUB_OUTPUT
      id: generate
    
    - name: Commit and push PDFs
      if: steps.changed-files.outputs.has_html == 'true' && steps.generate.outputs.pdf_count > 0
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all generated PDF files
        git add 'Tutorials/**/Files/**/*.pdf'
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No new PDFs to commit"
          exit 0
        fi
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${{ github.event.inputs.pr_number }}" ]]; then
            git commit -m "Generate PDFs from HTML files [skip ci]
        
        - Generated from PR #${{ github.event.inputs.pr_number }} (manual trigger)
        - ${{ steps.generate.outputs.pdf_count }} PDF files created
        - Auto-generated by generate-pdfs workflow"
          else
            git commit -m "Generate PDFs from HTML files [skip ci]
        
        - Generated for all HTML files (manual trigger)
        - ${{ steps.generate.outputs.pdf_count }} PDF files created
        - Auto-generated by generate-pdfs workflow"
          fi
        else
          git commit -m "Generate PDFs from HTML files [skip ci]
        
        - Generated from PR #${{ github.event.pull_request.number }}
        - ${{ steps.generate.outputs.pdf_count }} PDF files created
        - Auto-generated by generate-pdfs workflow"
        fi
        
        git push
        
        echo "✅ PDFs committed and pushed successfully"
