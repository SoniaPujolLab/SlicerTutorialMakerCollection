name: Tutorial Tests (Sequential)

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Tutorials/**'
      - 'Scripts/**'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Tutorials/**'
      - 'Scripts/**'
  
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      tutorial_filter:
        description: 'Tutorial ID to test (leave empty for all)'
        required: false
        type: string
      languages:
        description: 'Languages to test (space-separated)'
        default: 'pt-BR es-419 fr-FR'
        required: false
        type: string

env:
  SLICER_VERSION: '5.10.0'
  DEFAULT_LANGUAGES: 'pt-BR es-419 fr-FR'
  SCREEN_RESOLUTION: '1920x1080'
  PIP_NO_CACHE_DIR: '1'
  PYTHONUNBUFFERED: '1'

jobs:
  test-tutorials-sequential:
    name: Test Tutorials (Sequential)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --shm-size=4g
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install system dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: America/New_York
      run: |
        # Configure timezone non-interactively
        ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
        
        apt-get update -qq
        
        # Install Slicer prerequisites
        apt-get install -y \
          libglu1-mesa \
          libpulse-mainloop-glib0 \
          libnss3 \
          libasound2 \
          qt5dxcb-plugin \
          libsm6 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0
        
        # Install additional dependencies
        apt-get install -y \
          wget curl unzip \
          xvfb x11vnc x11-xserver-utils \
          python3 python3-pip \
          libgl1-mesa-glx \
          libxrender1 libxext6 libice6 \
          libfontconfig1 libxss1 \
          libglib2.0-0 libxrandr2 libxcomposite1 \
          libxdamage1 libxcursor1 libxi6 libxtst6 \
          ca-certificates \
          git bc
    
    - name: Setup Python
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install requests
    
    - name: Check available resources
      run: |
        echo "=== System Resources ==="
        echo "Memory:"
        free -h
        echo ""
        echo "Disk space:"
        df -h
        echo ""
        echo "CPU info:"
        nproc
        lscpu | grep "Model name" || echo "CPU info not available"
    
    - name: Cache Slicer installation
      id: cache-slicer
      uses: actions/cache@v4
      with:
        path: /opt/slicer
        key: slicer-${{ env.SLICER_VERSION }}-${{ runner.os }}
    
    - name: Download and install Slicer
      if: steps.cache-slicer.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Slicer ${{ env.SLICER_VERSION }}..."
        mkdir -p /opt/slicer
        cd /opt/slicer
        
        # Download Slicer 5.10.0
        wget -O slicer.tar.gz "https://download.slicer.org/bitstream/6911b598ac7b1c95e7934427"
        
        # Extract
        tar -xzf slicer.tar.gz --strip-components=1
        rm slicer.tar.gz
        
        # Make executable
        chmod +x ./Slicer
        
        # Verify installation
        ls -la /opt/slicer/
        echo "Slicer installation completed"
    
    - name: Verify cached Slicer
      if: steps.cache-slicer.outputs.cache-hit == 'true'
      run: |
        echo "‚úÖ Using cached Slicer installation"
        ls -la /opt/slicer/
        chmod +x /opt/slicer/Slicer
    
    - name: Setup virtual display
      run: |
        echo "Setting up virtual display ${{ env.SCREEN_RESOLUTION }}..."
        export DISPLAY=:99
        
        # Start Xvfb with specified resolution
        Xvfb :99 -screen 0 ${{ env.SCREEN_RESOLUTION }}x24 > /dev/null 2>&1 &
        sleep 3
        
        # Verify display
        echo "DISPLAY=:99" >> $GITHUB_ENV
    
    - name: Cache Slicer extensions
      id: cache-extensions
      uses: actions/cache@v4
      with:
        path: |
          /root/.config/NA-MIC
          /opt/slicer/slicer.org
        key: slicer-extensions-${{ env.SLICER_VERSION }}-v2
    
    - name: Install required Slicer extensions
      if: steps.cache-extensions.outputs.cache-hit != 'true'
      run: |
        echo "Installing required Slicer extensions..."
        export DISPLAY=:99
        
        # Run the extension installation script
        /opt/slicer/Slicer --no-splash --python-script Scripts/install-slicer-extensions.py
        
        echo "Slicer extensions installation completed"
    
    - name: Verify cached extensions
      if: steps.cache-extensions.outputs.cache-hit == 'true'
      run: |
        echo "‚úÖ Using cached Slicer extensions"
        ls -la /root/.config/NA-MIC/ || echo "Config dir empty"
        ls -la /opt/slicer/slicer.org/ || echo "Extensions dir empty"
    
    - name: Run all tutorials sequentially
      shell: bash
      run: |
        echo "=========================================="
        echo "Running tutorials SEQUENTIALLY"
        echo "This prevents resource contention and OOM"
        echo "=========================================="
        echo ""
        
        export DISPLAY=:99
        
        # Set languages to test
        if [[ -n "${{ github.event.inputs.languages }}" ]]; then
          test_languages="${{ github.event.inputs.languages }}"
        else
          test_languages="${{ env.DEFAULT_LANGUAGES }}"
        fi
        
        echo "Languages to test: $test_languages"
        echo ""
        
        # Get list of tutorials
        tutorial_count=0
        declare -a tutorial_names
        
        for tutorial_dir in Tutorials/*/; do
          if [[ -d "$tutorial_dir" ]]; then
            tutorial_name=$(basename "$tutorial_dir")
            
            # Extract ID from tutorial name
            if [[ "$tutorial_name" =~ ^([^_]+)_ ]]; then
              tutorial_id="${BASH_REMATCH[1]}"
              
              # Check filter
              if [[ -n "${{ github.event.inputs.tutorial_filter }}" ]]; then
                if [[ "$tutorial_id" != "${{ github.event.inputs.tutorial_filter }}" ]]; then
                  echo "Skipping $tutorial_id (filtered out)"
                  continue
                fi
              fi
              
              tutorial_names+=("$tutorial_name")
              tutorial_count=$((tutorial_count + 1))
            fi
          fi
        done
        
        echo "Total tutorials to test: $tutorial_count"
        echo ""
        
        # Process each tutorial sequentially
        current=0
        for tutorial_name in "${tutorial_names[@]}"; do
          current=$((current + 1))
          
          echo "=========================================="
          echo "Tutorial $current/$tutorial_count: $tutorial_name"
          echo "=========================================="
          
          # Clear pip cache before each tutorial
          echo "Clearing pip cache..."
          python3 -m pip cache purge 2>/dev/null || echo "No cache to clear"
          
          # Show available resources
          echo ""
          echo "Resources before test:"
          free -h | head -2
          df -h / | grep -E 'Filesystem|/$'
          echo ""
          
          # Setup tutorial files
          echo "Setting up tutorial files..."
          python3 Scripts/setup_tutorial_files.py \
            "$tutorial_name" \
            "Tutorials/$tutorial_name" \
            --languages $test_languages
          
          # Create results directory
          tutorial_results_dir="Tutorials/$tutorial_name/Results"
          mkdir -p "$tutorial_results_dir"
          
          # Run tests
          echo ""
          echo "Running tests..."
          python3 Scripts/run_tutorial_tests_ci.py \
            /opt/slicer/Slicer \
            --tutorial "$tutorial_name" \
            --languages $test_languages \
            --output "$tutorial_results_dir" \
            --timeout 300 || echo "‚ö†Ô∏è Tutorial test had issues (will continue)"
          
          # Show results
          echo ""
          if [[ -f "$tutorial_results_dir/test_report.json" ]]; then
            echo "‚úÖ Test completed"
            grep -E '"success_rate"|"total_tests"|"successful_tests"' "$tutorial_results_dir/test_report.json" || true
          else
            echo "‚ùå No test report generated"
            ls -la "$tutorial_results_dir" || true
          fi
          
          # Show resources after
          echo ""
          echo "Resources after test:"
          free -h | head -2
          df -h / | grep -E 'Filesystem|/$'
          
          echo ""
          echo "Finished tutorial $current/$tutorial_count"
          echo ""
          
          # Small delay between tutorials to allow cleanup
          sleep 5
        done
        
        echo "=========================================="
        echo "All tutorials completed!"
        echo "=========================================="
    
    - name: Copy generated tutorial outputs
      if: always()
      shell: bash
      run: |
        echo "Copying generated tutorial outputs..."
        
        # Set languages
        if [[ -n "${{ github.event.inputs.languages }}" ]]; then
          test_languages="${{ github.event.inputs.languages }}"
        else
          test_languages="${{ env.DEFAULT_LANGUAGES }}"
        fi
        
        # Find TutorialMaker outputs directory
        for possible_dir in /opt/slicer/lib/Slicer-*/qt-scripted-modules/TutorialMaker /opt/slicer/lib/Slicer-*/extensions-*/TutorialMaker*; do
          if [[ -d "$possible_dir/Outputs" ]]; then
            echo "Found TutorialMaker outputs in: $possible_dir/Outputs"
            
            # Copy outputs for each tutorial
            for tutorial_dir in Tutorials/*/; do
              tutorial_name=$(basename "$tutorial_dir")
              echo "Processing outputs for: $tutorial_name"
              
              IFS=' ' read -ra LANG_ARRAY <<< "$test_languages"
              for language in "${LANG_ARRAY[@]}"; do
                output_pattern="$possible_dir/Outputs/${tutorial_name}_${language}"
                if [[ -d "$output_pattern" ]]; then
                  target_dir="Tutorials/$tutorial_name/Translations/$language"
                  mkdir -p "$target_dir"
                  cp -r "$output_pattern"/* "$target_dir/" 2>/dev/null || true
                  echo "  ‚úÖ Copied outputs for $language"
                fi
              done
            done
            break
          fi
        done
    
    - name: Process test results
      if: always()
      shell: bash
      run: |
        echo "Processing test results for all tutorials..."
        echo ""
        
        for tutorial_dir in Tutorials/*/Results/; do
          if [[ -d "$tutorial_dir" ]]; then
            tutorial_name=$(basename $(dirname "$tutorial_dir"))
            echo "=== Results for: $tutorial_name ==="
            
            if [[ -f "${tutorial_dir}test_report.json" ]]; then
              echo "‚úÖ Test report found"
              cat "${tutorial_dir}test_report.json" | grep -E '"total_tests"|"successful_tests"|"failed_tests"|"success_rate"' || true
              
              # Show error hints if available
              error_hints=$(cat "${tutorial_dir}test_report.json" | grep -A 5 '"error_hints"' || true)
              if [[ -n "$error_hints" ]]; then
                echo "‚ö†Ô∏è Error hints: $error_hints"
              fi
            else
              echo "‚ùå No test report"
              # Show log files if available
              for log_file in "${tutorial_dir}"*.log; do
                if [[ -f "$log_file" ]]; then
                  echo "Last 10 lines of $(basename "$log_file"):"
                  tail -10 "$log_file"
                fi
              done
            fi
            echo ""
          fi
        done
    
    - name: Create Pull Request with test results
      if: always()
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        committer: GitHub Action <action@github.com>
        author: GitHub Action <action@github.com>
        commit-message: |
          Update test results and translations (sequential run #${{ github.run_number }})
          
          - Execution mode: Sequential (one tutorial at a time)
          - Prevents resource contention and OOM issues
        branch: test-results-sequential-${{ github.run_number }}
        delete-branch: true
        add-paths: |
          Tutorials/*/Results/
          Tutorials/*/Translations/
        title: 'Test Results (Sequential): Run #${{ github.run_number }}'
        body: |
          ## üß™ Tutorial Test Results (Sequential Execution)
          
          **Run:** #${{ github.run_number }}
          **Execution:** Sequential (one tutorial at a time to prevent OOM)
          
          ### Generated Content
          - ‚úÖ Test results in each `Tutorials/*/Results/`
          - ‚úÖ Generated translations for each tutorial and language
          
          Check individual tutorial directories for detailed results.
          
          ---
          *Auto-generated by [tutorial-tests-sequential.yml](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
        labels: |
          tutorial-tests
          automated
          sequential
        draft: false
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-sequential-${{ github.run_number }}
        path: |
          Tutorials/*/Results/
          Tutorials/*/Translations/
        retention-days: 30
    
    - name: Check test success
      if: always()
      run: |
        echo "Checking overall test success..."
        echo ""
        
        total_tutorials=0
        successful_tutorials=0
        
        for tutorial_dir in Tutorials/*/Results/; do
          if [[ -f "${tutorial_dir}test_report.json" ]]; then
            total_tutorials=$((total_tutorials + 1))
            
            SUCCESS_RATE=$(grep '"success_rate"' "${tutorial_dir}test_report.json" | sed 's/.*: *\([0-9.]*\).*/\1/' || echo "0")
            tutorial_name=$(basename $(dirname "$tutorial_dir"))
            
            echo "$tutorial_name: $SUCCESS_RATE%"
            
            # Consider successful if >= 75%
            if (( $(echo "$SUCCESS_RATE >= 75.0" | bc -l 2>/dev/null) )); then
              successful_tutorials=$((successful_tutorials + 1))
              echo "  ‚úÖ PASSED"
            else
              echo "  ‚ùå FAILED"
            fi
          fi
        done
        
        echo ""
        echo "=========================================="
        echo "Summary: $successful_tutorials/$total_tutorials tutorials passed"
        echo "=========================================="
        
        if [[ $successful_tutorials -eq $total_tutorials && $total_tutorials -gt 0 ]]; then
          echo "‚úÖ All tutorials passed!"
          exit 0
        elif [[ $successful_tutorials -gt 0 ]]; then
          echo "‚ö†Ô∏è Some tutorials failed"
          exit 1
        else
          echo "‚ùå All tutorials failed or no results"
          exit 1
        fi
