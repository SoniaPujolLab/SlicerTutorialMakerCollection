name: Tutorial Tests Automation

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Tutorials/**'
      - 'Scripts/**'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Tutorials/**'
      - 'Scripts/**'
  
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      tutorial_filter:
        description: 'Tutorial ID to test (leave empty for all)'
        required: false
        type: string
      languages:
        description: 'Languages to test (space-separated)'
        default: 'pt-BR es-419 fr-FR'
        required: false
        type: string

env:
  SLICER_VERSION: '5.10.0'
  DEFAULT_LANGUAGES: 'pt-BR es-419 fr-FR'
  SCREEN_RESOLUTION: '1920x1080'
  PIP_NO_CACHE_DIR: '1'
  PYTHONUNBUFFERED: '1'

jobs:
  detect-tutorials:
    name: Detect Tutorials
    runs-on: ubuntu-latest
    outputs:
      tutorials: ${{ steps.scan.outputs.tutorials }}
      tutorial-count: ${{ steps.scan.outputs.tutorial-count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Scan for tutorials with IDs
      id: scan
      run: |
        echo "Scanning for tutorials with valid IDs..."
        
        tutorials_json="["
        tutorial_count=0
        
        for tutorial_dir in Tutorials/*/; do
          if [[ -d "$tutorial_dir" ]]; then
            tutorial_name=$(basename "$tutorial_dir")
            echo "Checking tutorial: $tutorial_name"
            
            # Extract ID from tutorial name (everything before first underscore)
            if [[ "$tutorial_name" =~ ^([^_]+)_ ]]; then
              tutorial_id="${BASH_REMATCH[1]}"
              
              # Check if this tutorial should be filtered
              if [[ -n "${{ github.event.inputs.tutorial_filter }}" ]]; then
                if [[ "$tutorial_id" != "${{ github.event.inputs.tutorial_filter }}" ]]; then
                  echo "  Skipping $tutorial_id (filtered out)"
                  continue
                fi
              fi
              
              echo "  Found valid tutorial: $tutorial_id -> $tutorial_name"
              
              if [[ $tutorial_count -gt 0 ]]; then
                tutorials_json="$tutorials_json,"
              fi
              
              tutorials_json="$tutorials_json{\"id\":\"$tutorial_id\",\"name\":\"$tutorial_name\",\"path\":\"$tutorial_dir\"}"
              tutorial_count=$((tutorial_count + 1))
            else
              echo "  Skipping $tutorial_name (no valid ID pattern)"
            fi
          fi
        done
        
        tutorials_json="$tutorials_json]"
        
        echo "Found $tutorial_count tutorials with valid IDs"
        echo "tutorials=$tutorials_json" >> $GITHUB_OUTPUT
        echo "tutorial-count=$tutorial_count" >> $GITHUB_OUTPUT
        
        echo "Tutorials JSON: $tutorials_json"

  test-tutorials:
    name: Test Tutorial
    runs-on: ubuntu-latest
    needs: detect-tutorials
    if: needs.detect-tutorials.outputs.tutorial-count > 0
    container:
      image: ubuntu:22.04
    
    strategy:
      fail-fast: false
      matrix:
        tutorial: ${{ fromJson(needs.detect-tutorials.outputs.tutorials) }}
    
    steps:
    - name: Install git for checkout
      run: |
        apt-get update -qq
        apt-get install -y git
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install system dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: America/New_York
      run: |
        # Configure timezone non-interactively
        ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
        
        apt-get update -qq
        
        # Install Slicer prerequisites
        apt-get install -y \
          libglu1-mesa \
          libpulse-mainloop-glib0 \
          libnss3 \
          libasound2 \
          qt5dxcb-plugin \
          libsm6 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0
        
        # Install additional dependencies
        apt-get install -y \
          wget curl unzip \
          xvfb x11vnc x11-xserver-utils \
          python3 python3-pip \
          libgl1-mesa-glx \
          libxrender1 libxext6 libice6 \
          libfontconfig1 libxss1 \
          libglib2.0-0 libxrandr2 libxcomposite1 \
          libxdamage1 libxcursor1 libxi6 libxtst6 \
          ca-certificates \
          git bc
    
    - name: Setup Python
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install requests
        
        # Pre-download common packages to avoid issues during test
        python3 -m pip install --no-cache-dir numpy || echo "numpy install optional"
    
    - name: Check available resources
      run: |
        echo "=== System Resources ==="
        echo "Memory:"
        free -h
        echo ""
        echo "Disk space:"
        df -h
        echo ""
        echo "CPU info:"
        nproc
        lscpu | grep "Model name" || echo "CPU info not available"
    
    - name: Cache Slicer installation
      id: cache-slicer
      uses: actions/cache@v4
      with:
        path: /opt/slicer
        key: slicer-${{ env.SLICER_VERSION }}-${{ runner.os }}
    
    - name: Download and install Slicer
      if: steps.cache-slicer.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Slicer ${{ env.SLICER_VERSION }}..."
        mkdir -p /opt/slicer
        cd /opt/slicer
        
        # Download Slicer 5.10.0
        wget -O slicer.tar.gz "https://download.slicer.org/bitstream/6911b598ac7b1c95e7934427"
        
        # Extract
        tar -xzf slicer.tar.gz --strip-components=1
        rm slicer.tar.gz
        
        # Make executable
        chmod +x ./Slicer
        
        # Verify installation
        ls -la /opt/slicer/
        echo "Slicer installation completed"
    
    - name: Verify cached Slicer
      if: steps.cache-slicer.outputs.cache-hit == 'true'
      run: |
        echo "‚úÖ Using cached Slicer installation"
        ls -la /opt/slicer/
        chmod +x /opt/slicer/Slicer
    
    - name: Setup virtual display
      run: |
        echo "Setting up virtual display ${{ env.SCREEN_RESOLUTION }}..."
        export DISPLAY=:99
        
        # Start Xvfb with specified resolution
        Xvfb :99 -screen 0 ${{ env.SCREEN_RESOLUTION }}x24 > /dev/null 2>&1 &
        sleep 3
        
        # Verify display
        echo "DISPLAY=$DISPLAY" >> $GITHUB_ENV
    
    - name: Cache Slicer extensions
      id: cache-extensions
      uses: actions/cache@v4
      with:
        path: |
          /root/.config/NA-MIC
          /opt/slicer/slicer.org
        key: slicer-extensions-${{ env.SLICER_VERSION }}-v2
    
    - name: Install required Slicer extensions
      if: steps.cache-extensions.outputs.cache-hit != 'true'
      run: |
        echo "Installing required Slicer extensions..."
        export DISPLAY=:99
        
        # Run the extension installation script
        /opt/slicer/Slicer --no-splash --python-script Scripts/install-slicer-extensions.py
        
        echo "Slicer extensions installation completed"
    
    - name: Verify cached extensions
      if: steps.cache-extensions.outputs.cache-hit == 'true'
      run: |
        echo "‚úÖ Using cached Slicer extensions"
        ls -la /root/.config/NA-MIC/ || echo "Config dir empty"
        ls -la /opt/slicer/slicer.org/ || echo "Extensions dir empty"
    
    - name: Prepare tutorial test environment
      shell: bash
      run: |
        echo "Preparing test environment for tutorial: ${{ matrix.tutorial.name }}"
        
        # Clear pip cache to free up space
        python3 -m pip cache purge 2>/dev/null || echo "No pip cache to clear"
        
        # Create Results directory in tutorial folder
        tutorial_results_dir="Tutorials/${{ matrix.tutorial.name }}/Results"
        mkdir -p "$tutorial_results_dir"
        echo "Created results directory: $tutorial_results_dir"
        
        # Set languages to test
        if [[ -n "${{ github.event.inputs.languages }}" ]]; then
          test_languages="${{ github.event.inputs.languages }}"
        else
          test_languages="${{ env.DEFAULT_LANGUAGES }}"
        fi
        
        echo "TEST_LANGUAGES=$test_languages" >> $GITHUB_ENV
        echo "TUTORIAL_RESULTS_DIR=$tutorial_results_dir" >> $GITHUB_ENV
        echo "Will test languages: $test_languages"
    
    - name: Setup tutorial files in TutorialMaker
      shell: bash
      run: |
        echo "Setting up tutorial files for: ${{ matrix.tutorial.name }}"
        
        python3 Scripts/setup_tutorial_files.py \
          "${{ matrix.tutorial.name }}" \
          "Tutorials/${{ matrix.tutorial.name }}" \
          --languages $TEST_LANGUAGES
    
    - name: Run tutorial tests
      run: |
        echo "Running tests for tutorial: ${{ matrix.tutorial.name }} (ID: ${{ matrix.tutorial.id }})"
        echo "Languages: $TEST_LANGUAGES"
        echo "Results directory: $TUTORIAL_RESULTS_DIR"
        
        # Check resources before running
        echo "=== Resources before test ==="
        free -h
        df -h /
        
        export DISPLAY=:99
        
        # Change to repository root
        cd "$GITHUB_WORKSPACE"
        
        # Run the test script
        python3 Scripts/run_tutorial_tests_ci.py \
          /opt/slicer/Slicer \
          --tutorial "${{ matrix.tutorial.name }}" \
          --languages $TEST_LANGUAGES \
          --output "$TUTORIAL_RESULTS_DIR" \
          --timeout 900
        
        echo "Tutorial tests completed"
        
        # Check resources after running
        echo "=== Resources after test ==="
        free -h
        df -h /
    
    - name: Copy generated tutorial outputs
      if: always()
      shell: bash
      run: |
        echo "Copying generated tutorial outputs (HTML/MD)..."
        
        # Extract tutorial name without ID prefix
        tutorial_full_name="${{ matrix.tutorial.name }}"
        tutorial_name_only="${tutorial_full_name#*_}"
        
        echo "Full tutorial name: $tutorial_full_name"
        echo "Tutorial name (without ID): $tutorial_name_only"
        
        # Find TutorialMaker outputs directory
        # Try multiple possible locations
        for possible_dir in \
          /opt/slicer/slicer.org/Extensions-*/TutorialMaker/lib/Slicer-*/qt-scripted-modules \
          /opt/slicer/lib/Slicer-*/qt-scripted-modules/TutorialMaker \
          /opt/slicer/lib/Slicer-*/extensions-*/TutorialMaker*; do
          
          if [[ -d "$possible_dir/Outputs" ]]; then
            echo "Found TutorialMaker outputs in: $possible_dir/Outputs"
            
            # List all outputs for debugging
            echo "Available output directories:"
            ls -la "$possible_dir/Outputs/" | grep "^d" || echo "  (none)"
            
            # Copy outputs for this tutorial
            IFS=' ' read -ra LANG_ARRAY <<< "$TEST_LANGUAGES"
            for language in "${LANG_ARRAY[@]}"; do
              # Convert language format if needed (pt-BR -> pt_BR for directory names)
              lang_dir=$(echo "$language" | tr '-' '_')
              
              # Try both formats: language_code and language-code
              for lang_variant in "$language" "$lang_dir"; do
                output_dir="$possible_dir/Outputs/${tutorial_name_only}_${lang_variant}"
                
                if [[ -d "$output_dir" ]]; then
                  echo "  Found outputs: $output_dir"
                  
                  # Create target directory in Files folder
                  target_dir="Tutorials/$tutorial_full_name/Files/$language"
                  mkdir -p "$target_dir"
                  
                  # Copy entire output directory (HTML, MD, images, etc.)
                  echo "    Copying all files from output directory..."
                  cp -r "$output_dir"/* "$target_dir/" 2>/dev/null || true
                  echo "    ‚úÖ Copied all files for $language"
                  
                  # List what was copied
                  echo "    Files in target:"
                  ls -lh "$target_dir/" 2>/dev/null || echo "    (empty)"
                  
                  break
                fi
              done
            done
            break
          fi
        done
        
        echo ""
        echo "Generated files summary:"
        if [[ -d "Tutorials/$tutorial_full_name/Files" ]]; then
          find "Tutorials/$tutorial_full_name/Files" -type f
        else
          echo "  No files generated"
        fi
    
    - name: Process test results
      if: always()
      shell: bash
      run: |
        echo "Processing test results for: ${{ matrix.tutorial.name }}"
        echo ""
        
        if [[ -f "$TUTORIAL_RESULTS_DIR/test_report.json" ]]; then
          echo "‚úÖ Test report found"
          cat "$TUTORIAL_RESULTS_DIR/test_report.json" | grep -E '"total_tests"|"successful_tests"|"failed_tests"|"success_rate"' || true
          
          # Show error hints if available
          error_hints=$(cat "$TUTORIAL_RESULTS_DIR/test_report.json" | grep -A 5 '"error_hints"' || true)
          if [[ -n "$error_hints" ]]; then
            echo "‚ö†Ô∏è Error hints: $error_hints"
          fi
        else
          echo "‚ùå No test report"
          # Show log files if available
          for log_file in "$TUTORIAL_RESULTS_DIR"/*.log; do
            if [[ -f "$log_file" ]]; then
              echo "Last 10 lines of $(basename "$log_file"):"
              tail -10 "$log_file"
            fi
          done
        fi
    
    - name: Verify generated files
      if: always()
      shell: bash
      run: |
        echo "=== Checking generated files ==="
        echo "Current directory: $(pwd)"
        echo ""
        
        # Check if we have files to commit
        has_results=false
        has_files=false
        
        if [[ -d "Tutorials/${{ matrix.tutorial.name }}/Results" ]]; then
          echo "‚úÖ Results directory exists"
          ls -lh "Tutorials/${{ matrix.tutorial.name }}/Results/" | head -n 10
          has_results=true
        fi
        
        if [[ -d "Tutorials/${{ matrix.tutorial.name }}/Files" ]]; then
          echo "‚úÖ Files directory exists"
          echo "Languages found:"
          ls -d "Tutorials/${{ matrix.tutorial.name }}/Files/"*/ 2>/dev/null || echo "  No language folders"
          echo ""
          echo "Total files:"
          find "Tutorials/${{ matrix.tutorial.name }}/Files" -type f | wc -l
          has_files=true
        fi
        
        # Set environment variable for PR step
        if [[ "$has_results" == "true" ]] || [[ "$has_files" == "true" ]]; then
          echo "HAS_FILES=true" >> $GITHUB_ENV
        else
          echo "HAS_FILES=false" >> $GITHUB_ENV
        fi
    
    - name: Create Pull Request with test results
      if: always() && env.HAS_FILES == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        committer: GitHub Action <action@github.com>
        author: GitHub Action <action@github.com>
        commit-message: |
          Update test results and generated outputs for ${{ matrix.tutorial.name }}
          
          - Languages tested: ${{ env.TEST_LANGUAGES }}
          - Tutorial ID: ${{ matrix.tutorial.id }}
          - Generated HTML/MD files included
        branch: test-results-${{ matrix.tutorial.id }}-${{ github.run_number }}
        delete-branch: true
        add-paths: |
          Tutorials/${{ matrix.tutorial.name }}/Results/
          Tutorials/${{ matrix.tutorial.name }}/Files/
        title: 'Test Results: ${{ matrix.tutorial.name }}'
        body: |
          ## üß™ Tutorial Test Results
          
          **Tutorial:** ${{ matrix.tutorial.name }} (`${{ matrix.tutorial.id }}`)
          **Languages tested:** ${{ env.TEST_LANGUAGES }}
          
          ### Generated Content
          - ‚úÖ Test results in `Results/`
          - ‚úÖ Generated HTML/MD files in `Files/` (one folder per language)
          
          ### Files Included
          - Test reports (JSON) in `Results/`
          - Tutorial HTML files (localized) in `Files/{language}/`
          - Tutorial Markdown files (localized) in `Files/{language}/`
          
          ---
          *Auto-generated by [tutorial-tests.yml workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
        labels: |
          tutorial-tests
          automated
        draft: false
    
    - name: List files to upload
      if: always()
      shell: bash
      run: |
        echo "=== Files prepared for upload ==="
        echo ""
        echo "Results directory:"
        if [[ -d "Tutorials/${{ matrix.tutorial.name }}/Results" ]]; then
          ls -lh "Tutorials/${{ matrix.tutorial.name }}/Results/"
        else
          echo "  (not found)"
        fi
        
        echo ""
        echo "Files directory (HTML/MD):"
        if [[ -d "Tutorials/${{ matrix.tutorial.name }}/Files" ]]; then
          find "Tutorials/${{ matrix.tutorial.name }}/Files" -type f -exec ls -lh {} \;
        else
          echo "  (not found)"
        fi
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.tutorial.id }}
        path: |
          Tutorials/${{ matrix.tutorial.name }}/Results/
          Tutorials/${{ matrix.tutorial.name }}/Files/
        retention-days: 30
        compression-level: 6
    
    - name: Check test success
      if: always()
      shell: bash
      run: |
        if [[ -f "$TUTORIAL_RESULTS_DIR/test_report.json" ]]; then
          # Extract success rate using grep and basic text processing
          SUCCESS_RATE=$(grep '"success_rate"' "$TUTORIAL_RESULTS_DIR/test_report.json" | sed 's/.*: *\([0-9.]*\).*/\1/' || echo "0")
          
          echo "Tutorial ${{ matrix.tutorial.name }} success rate: $SUCCESS_RATE%"
          
          # Consider test successful if success rate >= 75%
          if (( $(echo "$SUCCESS_RATE >= 75.0" | bc -l 2>/dev/null) )); then
            echo "‚úÖ Tutorial tests passed"
          else
            echo "‚ùå Tutorial tests failed - success rate too low"
            exit 1
          fi
        else
          echo "‚ùå No test results available"
          exit 1
        fi